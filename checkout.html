<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atoz Mobile - Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { padding-bottom: 100px; }
        .payment-option {
            transition: all 0.2s ease-in-out;
        }
        .payment-option input:checked + label {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white dark:bg-gray-800 shadow-sm p-4">
        <div class="container mx-auto flex items-center">
            <a href="cart.html" class="text-gray-600 dark:text-gray-300 mr-4"><i class="fas fa-arrow-left text-xl"></i></a>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Checkout</h1>
        </div>
    </header>

    <main class="container mx-auto p-4 space-y-6">
        <!-- Order Summary -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-3">Order Summary</h2>
            <div id="order-summary-list" class="space-y-2 text-sm">
                <!-- Summary items will be injected here -->
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 mt-3 pt-3 flex justify-between items-center">
                <span class="font-bold text-gray-800 dark:text-white">Total</span>
                <span id="summary-total" class="font-bold text-lg text-amber-600">रू 0</span>
            </div>
        </div>

        <!-- Shipping Information Form -->
        <form id="checkout-form" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm space-y-4">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white">Shipping Information</h2>
            <div>
                <label for="name" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                <input type="text" id="name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            </div>
            <div>
                <label for="address" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Address</label>
                <input type="text" id="address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            </div>
            <div>
                <label for="phone" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
                <input type="tel" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            </div>
        </form>

        <!-- Payment Method -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-3">Payment Method</h2>
            <div class="space-y-3">
                <div class="payment-option">
                    <input type="radio" name="payment" id="cod" value="COD" class="hidden" checked>
                    <label for="cod" class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer">
                        <i class="fas fa-money-bill-wave text-xl text-green-500 mr-3"></i>
                        <span class="font-semibold text-gray-700 dark:text-gray-300">Cash on Delivery</span>
                    </label>
                </div>
                <div class="payment-option">
                    <input type="radio" name="payment" id="esewa" value="eSewa" class="hidden">
                    <label for="esewa" class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer">
                        <img src="https://esewa.com.np/common/images/esewa_logo.png" class="h-6 mr-3" alt="eSewa">
                        <span class="font-semibold text-gray-700 dark:text-gray-300">eSewa</span>
                    </label>
                </div>
                 <div class="payment-option">
                    <input type="radio" name="payment" id="khalti" value="Khalti" class="hidden">
                    <label for="khalti" class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer">
                         <img src="https://khalti.com/static/images/logo-dark.svg" class="h-6 mr-3" alt="Khalti">
                        <span class="font-semibold text-gray-700 dark:text-gray-300">Khalti</span>
                    </label>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 p-3 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] z-50">
        <div class="container mx-auto flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total to Pay</p>
                <p id="total-to-pay" class="text-2xl font-extrabold text-gray-900 dark:text-white">रू 0</p>
            </div>
            <button id="place-order-btn" class="w-1/2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 px-4 rounded-lg hover:from-green-600 hover:to-emerald-600 transition duration-300 flex items-center justify-center">
                <span id="order-spinner" class="hidden h-5 w-5 animate-spin rounded-full border-b-2 border-white"></span>
                <span id="order-text">Place Order</span>
            </button>
        </div>
    </div>
    
    <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>


<script>
    // -------------------
    //  SECURITY & CONFIG
    // -------------------
    document.addEventListener('contextmenu', event => event.preventDefault());
    const firebaseConfig = {
  apiKey: "AIzaSyBIwo7phmACkms_fjwfhEVJNgx5eiEQWBE",
  authDomain: "atozmobialstores.firebaseapp.com",
  projectId: "atozmobialstores",
  storageBucket: "atozmobialstores.firebasestorage.app",
  messagingSenderId: "879111411317",
  appId: "1:879111411317:web:589d4b750cc113572a8a3c",
  measurementId: "G-HDVSY5KYBK"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let totalAmount = 0;

    // -------------------
    //  COMMON FUNCTIONS
    // -------------------
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast fixed bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-100 ${isError ? 'bg-red-500' : 'bg-green-600'} text-white`;
        setTimeout(() => { toast.style.opacity = '0'; }, 3000);
    }

    // -------------------
    // PAGE LOGIC
    // -------------------
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadCheckoutData();
                fetchUserProfile();
            } else {
                window.location.replace('login.html');
            }
        });

        document.getElementById('place-order-btn').addEventListener('click', placeOrder);
    });

    function loadCheckoutData() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        if (cart.length === 0) {
            showToast("Your cart is empty. Redirecting...", true);
            setTimeout(() => window.location.replace('index.html'), 2000);
            return;
        }

        const summaryList = document.getElementById('order-summary-list');
        summaryList.innerHTML = '';
        totalAmount = 0;

        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            totalAmount += itemTotal;
            summaryList.innerHTML += `
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">${item.name} (x${item.quantity})</span>
                    <span class="text-gray-800 dark:text-gray-300">रू ${itemTotal.toLocaleString()}</span>
                </div>
            `;
        });

        document.getElementById('summary-total').textContent = `रू ${totalAmount.toLocaleString()}`;
        document.getElementById('total-to-pay').textContent = `रू ${totalAmount.toLocaleString()}`;
    }

    async function fetchUserProfile() {
        if (!currentUser) return;
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                document.getElementById('name').value = userData.name || '';
                document.getElementById('address').value = userData.address || '';
                document.getElementById('phone').value = userData.phone || '';
            }
        } catch (error) {
            console.error("Error fetching user profile: ", error);
            showToast("Could not load your profile data.", true);
        }
    }

    async function placeOrder() {
        const form = document.getElementById('checkout-form');
        if (!form.checkValidity()) {
            showToast("Please fill in all shipping details.", true);
            form.reportValidity();
            return;
        }

        const button = document.getElementById('place-order-btn');
        const spinner = document.getElementById('order-spinner');
        const text = document.getElementById('order-text');
        
        button.disabled = true;
        spinner.classList.remove('hidden');
        text.classList.add('hidden');

        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const shippingDetails = {
            name: document.getElementById('name').value,
            address: document.getElementById('address').value,
            phone: document.getElementById('phone').value,
        };
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        try {
            // 1. Create the main order document
            const orderRef = await db.collection('orders').add({
                user_id: currentUser.uid,
                total_amount: totalAmount,
                payment_method: paymentMethod,
                shipping_address: shippingDetails,
                status: 'Placed', // Initial status
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 2. Create order_items in a batch
            const batch = db.batch();
            cart.forEach(item => {
                const orderItemRef = db.collection('order_items').doc();
                batch.set(orderItemRef, {
                    order_id: orderRef.id,
                    product_id: item.id,
                    product_name: item.name,
                    product_image: item.image,
                    quantity: item.quantity,
                    price: item.price // Price per item
                });
                
                // 3. (Optional but recommended) Update product stock
                const productRef = db.collection('products').doc(item.id);
                batch.update(productRef, {
                    stock: firebase.firestore.FieldValue.increment(-item.quantity)
                });
            });

            // 4. Update used redeem codes if any
            const usedCodes = cart.filter(item => item.redeemCode).map(item => item.redeemCode);
            if (usedCodes.length > 0) {
                 const uniqueCodes = [...new Set(usedCodes)]; // Get unique codes
                 const codesQuery = await db.collection('redeem_codes')
                    .where('user_id', '==', currentUser.uid)
                    .where('code', 'in', uniqueCodes).get();
                 codesQuery.forEach(doc => {
                     batch.update(doc.ref, { status: 'used', used_at: firebase.firestore.FieldValue.serverTimestamp(), order_id: orderRef.id });
                 });
            }

            await batch.commit();

            // 5. Clear cart and redirect
            localStorage.removeItem('cart');
            showToast("Order placed successfully!");
            setTimeout(() => window.location.replace(`order.html?success=true&orderId=${orderRef.id}`), 1500);

        } catch (error) {
            console.error("Error placing order: ", error);
            showToast("Failed to place order. Please try again.", true);
            button.disabled = false;
            spinner.classList.add('hidden');
            text.classList.remove('hidden');
        }
    }
</script>
</body>
</html>